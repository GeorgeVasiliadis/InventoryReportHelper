<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bootstrap Local Template</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <style>
      .table-container {
        margin-bottom: 30px;
        overflow-x: auto;
      }
      .toast-container {
        position: absolute;
        top: 10px;
        right: 10px;
      }
      .header-panel {
        background-color: #34393e;
        color: white;
        padding: 15px;
        text-align: center;
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 20px;
      }
      @media (max-width: 768px) {
        .header-panel {
          font-size: 1.2rem;
          padding: 10px;
        }
        .container {
          padding: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="header-panel">Inventory Report Helper</div>
    <div class="container mt-5 shadow p-2">
      <div class="mb-3 row align-items-center">
        <label
          for="description"
          class="col-2 col-form-label fw-bold text-center"
        >
          Description
        </label>
        <div class="col-10">
          <input
            type="text"
            id="description"
            class="form-control"
            value="Greek"
            spellcheck="false"
            autocomplete="off"
          />
        </div>
      </div>
      <div class="table-container">
        <table class="table table-bordered table-striped" id="table">
          <thead>
            <tr>
              <th class="w-25">Publication</th>
              <th class="w-25">Type</th>
              <th class="w-25">Weight (g)</th>
              <th class="w-25">Count</th>
              <th class="w-10">Delete</th>
            </tr>
          </thead>
          <tbody>
            <!-- Row will be added on page load -->
          </tbody>
        </table>
        <div class="text-center">
          <button class="btn btn-secondary" onclick="addRow()">+</button>
        </div>
      </div>
    </div>
    <div class="text-center p-3">
      <button class="btn btn-outline-secondary" onclick="copyData()">
        <i class="bi bi-clipboard px-1"></i>Copy
      </button>
      <button class="btn btn-outline-secondary" onclick="downloadData()">
        <i class="bi bi-download px-1"></i>Download
      </button>
    </div>

    <div class="toast-container">
      <!-- Error toast -->
      <div
        id="toast-error"
        class="toast text-bg-danger"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
        data-bs-delay="3000"
      >
        <div class="toast-body text-center">Action Error!</div>
      </div>

      <!-- Success toast -->
      <div
        id="toast-success"
        class="toast text-bg-success"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
        data-bs-delay="3000"
      >
        <div class="toast-body text-center">Action successful!</div>
      </div>
    </div>

    <script>
      const weightMapping = {
        Magazine: 19.15,
        Tract: 2.333,
        Card: 1.425,
        lffi: 22.02,
        "S-4": 0.7,
        "S-24": 0.8,
        inv: 1.444,
      };
      // Function to populate the dropdown with weightMapping keys
      function populateTypeDropdown(selectElement) {
        for (let key in weightMapping) {
          let option = document.createElement("option");
          option.value = key;
          option.textContent = key;
          selectElement.appendChild(option);
        }
      }
      function addRow() {
        let table = document
          .getElementById("table")
          .getElementsByTagName("tbody")[0];
        let newRow = table.insertRow();

        let cell1 = newRow.insertCell(0);
        let cell2 = newRow.insertCell(1);
        let cell3 = newRow.insertCell(2);
        let cell4 = newRow.insertCell(3);
        let cell5 = newRow.insertCell(4); // Delete button cell

        cell1.innerHTML =
          '<input type="text" class="form-control" spellcheck="false" autocomplete="off" />';
        cell2.innerHTML =
          '<select class="form-control" onchange="recalculateCount(this)"></select>';
        cell3.innerHTML =
          '<input type="number" step="0.01" class="form-control" oninput="recalculateCount(this)" />';
        cell4.innerHTML = '<input type="number" class="form-control" />';
        cell5.classList.add("text-center"); // Center content in the cell
        cell5.innerHTML =
          '<button class="btn btn-danger btn-sm" onclick="deleteRow(this)"><i class="bi bi-trash"></i></button>';

        // Populate the dropdown
        let select = cell2.querySelector("select");
        populateTypeDropdown(select);
        select.value = Object.keys(weightMapping)[0];
      }
      function deleteRow(button) {
        let row = button.closest("tr");
        row.remove();
      }
      function recalculateCount(element) {
        let row = element.closest("tr");
        let type = row.cells[1].querySelector("select").value;
        let countInput = row.cells[3].querySelector("input");
        let weight = parseFloat(row.cells[2].querySelector("input").value);
        let mappedWeight = weightMapping[type] || 0; // No `.toLowerCase()`
        if (!isNaN(weight) && mappedWeight > 0) {
          let count = weight / mappedWeight;
          countInput.value = Math.round(count.toFixed(2)); // Set the calculated count with 2 decimal places
        }
      }
      function copyData() {
        let exportObject = prepareExport();
        if (!exportObject) return; // Stop if invalid data

        const exportString = generateExportText(exportObject);

        navigator.clipboard
          .writeText(exportString)
          .then(() => showToast("Data copied to clipboard!", "success"))
          .catch((err) => console.error("Failed to copy:", err));
      }

      function generateExportText(exportObject) {
        let output = "";

        // Get description from title (editable later if you change <h2>)
        const description =
          document.getElementById("description").value || "Inventory";

        output += `--- ${description} ---\n`;

        // Sort keys alphabetically
        let sortedKeys = Object.keys(exportObject).sort();
        for (let key of sortedKeys) {
          output += `${key}: ${exportObject[key]}\n`;
        }

        return output.trim();
      }

      function downloadData() {
        let exportObject = prepareExport();
        if (!exportObject) return; // Stop if invalid data

        const exportString = JSON.stringify(exportObject, null, 2);

        const blob = new Blob([exportString], { type: "application/json" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "exported_data.json";
        link.click();
        showToast("Data downloaded locally!", "success");
      }

      // Extracted common logic
      function prepareExport() {
        let exportObject = {};
        let hasUndefined = false;
        let rows = document
          .getElementById("table")
          .getElementsByTagName("tbody")[0]
          .getElementsByTagName("tr");

        for (let row of rows) row.classList.remove("table-danger");

        for (let i = 0; i < rows.length; i++) {
          let publicationName = rows[i].cells[0].querySelector("input").value;
          let count = rows[i].cells[3].querySelector("input").value;
          if (!publicationName || !count) {
            rows[i].classList.add("table-danger");
            hasUndefined = true;
          }
        }
        if (hasUndefined) {
          showToast("Can't have Publication or Count undefined", "error");
          return null;
        }

        exportObject = { ...exportObject, ...getTableData() };
        return exportObject;
      }
      function showToast(message, type = "success") {
        let toastEl = document.getElementById(
          type === "success" ? "toast-success" : "toast-error"
        );
        toastEl.querySelector(".toast-body").textContent = message;
        let toast = new bootstrap.Toast(toastEl);
        toast.show();
        setTimeout(() => toast.hide(), 3000);
      }
      function getTableData() {
        let table = document.getElementById("table");
        let rows = table
          .getElementsByTagName("tbody")[0]
          .getElementsByTagName("tr");
        let tableData = {};
        for (let i = 0; i < rows.length; i++) {
          let publication = rows[i].cells[0].querySelector("input").value;
          let type = rows[i].cells[1].querySelector("select").value;
          let weight = rows[i].cells[2].querySelector("input").value;
          let count = rows[i].cells[3].querySelector("input").value;
          // Use the weight from the mapping if no input is provided
          if (!weight) {
            weight = weightMapping[type] || ""; // No `.toLowerCase()`
          }
          let key = `${publication}`;
          // Handle overlapping keys by adding an incrementing number before the language
          let uniqueKey = key;
          let counter = 1;
          while (tableData[uniqueKey]) {
            uniqueKey = `${publication}-${counter}`; // Number before the language
            counter++;
          }
          tableData[uniqueKey] = count;
        }
        return tableData;
      }
      // Populate the initial row's dropdown on page load
      window.onload = function () {
        let firstRowSelect = document.querySelector(
          "#table tbody tr td select"
        );
        populateTypeDropdown(firstRowSelect);
        // Set the default type for the first row to the first available key
        firstRowSelect.value = Object.keys(weightMapping)[0];
      };
      window.onload = function () {
        addRow();
      };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
